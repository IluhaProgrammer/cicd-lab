name: Deploy to Production

on:
    push:
        branches: ["main"]
    
permissions:
    contents: read
    id-token: write

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Simulate build
              run: echo "Build complete"

    deploy:
        runs-on: ubuntu-latest
        needs: build
        environment: production
        steps:
            - name: Checkout repository 
              uses: actions/checkout@v4
            
            - name: Restore SSH key
              env: 
                SSH_KEY: ${{ secrets.SSH_KEY }}
              run: |
                echo "$SSH_KEY" > /tmp/ci_deploy_key
                chmod 600 /tmp/ci_deploy_key
            
            - name: Add host to known_hosts
              env:
                HOST: ${{ secrets.PRODUCTION_HOST }}
              run: |
                ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

            - name: Deploy to server
              env:
                HOST: ${{ secrets.PRODUCTION_HOST }}
              run: |
                echo "Trying to connect to $HOST"
                ssh -i /tmp/ci_deploy_key -o StrictHostKeyChecking=no deployuser@"$HOST" "echo 'Hello from CI'"